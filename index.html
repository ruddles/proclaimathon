
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
   <head>
      <title></title>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

      <link href="./css/bootstrap.css" rel="stylesheet">
       <style>
         body {
           padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
         }
       </style>
       <link href="./css/bootstrap-responsive.css" rel="stylesheet">

      <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>

      <script type="text/javascript" src="./route.js" ></script>
      <script type="text/javascript">

         var map;
         var line;

         var people = [

            {Name: "Andrew Pirie", Image: "./Pirie.jpg", Distance: 91.35},
            {Name: "Ian Childs", Image: "./Childs.jpg", Distance: 53.03},
            {Name: "Dan Jones", Image: "./Jones.jpg", Distance: 13.50},
            {Name: "James Palfreyman", Image: "./Palf.jpg", Distance: 70.91},
            {Name: "Paul Jeffrey", Image: "./Jeffrey.jpg", Distance: 107.59},
            {Name: "Nigel Pinto", Image: "./Pinto.jpg", Distance: 44.89},
            {Name: "Roy Bird", Image: "./Bird.jpg", Distance: 44.80},
            {Name: "Richard Buchan", Image: "./Buchan.jpg", Distance: 0.00}
         ]

         function GetMap()
         {
            map = new Microsoft.Maps.Map(document.getElementById("mapDiv"), {credentials:"AsKrJMA-VVVVlRoA5VExoPUNGmn1i7kO1NS29xygJHLXgtbb6yY9n6s9diWd0eQX",
               showDashboard: false,
               disableUserInput: false
            });

            map.setView({ zoom: 6, center: new Microsoft.Maps.Location(47.5153879564082, 4.82774019241333)});
            line = new Microsoft.Maps.Polyline(route, {strokeColor: new Microsoft.Maps.Color(200, 72, 118, 255)});
            map.entities.push(line);

            for (var i = 0; i < people.length; i++) 
            {
               var person = people[i];
               var pushpin = new Microsoft.Maps.Pushpin(getLocForDistance(person.Distance), {icon: person.Image, width: 50, height: 50}); 
               map.entities.push(pushpin);
            }

         }

         function createDirectionsManager()
         {
            directionsManager = new Microsoft.Maps.Directions.DirectionsManager(map);
            directionsManager.resetDirections();
            Microsoft.Maps.Events.addHandler(directionsManager, 'directionsUpdated', function() 
                     { 
                        map.setView({ zoom: 6, center: new Microsoft.Maps.Location(47.5153879564082, 4.82774019241333)});

                        for (var i = 0; i < people.length; i++) {
                           var person = people[i];
                           var pushpin = new Microsoft.Maps.Pushpin(getLocForDistance(person.Distance), {icon: person.Image, width: 50, height: 50}); 
                           map.entities.push(pushpin);
                        }
                     });
            // Set Route Mode to driving 
            directionsManager.setRequestOptions({ routeMode: Microsoft.Maps.Directions.RouteMode.driving, routeDraggable: false });
            directionsManager.setRenderOptions({
                itineraryContainer: document.getElementById('directionsItinerary'),
                waypointPushpinOptions:{visible:false},
                viapointPushpinOptions:{visible:false}
            });
            var seattleWaypoint = new Microsoft.Maps.Directions.Waypoint({ address: 'Southsea, UK', shortAddress: 'Southsea' });
            directionsManager.addWaypoint(seattleWaypoint);
            var tacomaWaypoint = new Microsoft.Maps.Directions.Waypoint({ address: 'Florance, Italy' });
            directionsManager.addWaypoint(tacomaWaypoint);

            directionsManager.calculateDirections();
         }

         function getLocForDistance(distance)
         {
            // var routePath = directionsManager.getRouteResult()[0].routeLegs[0].subLegs[0].routePath;
            var prevLat = route[0].latitude;
            var prevLon = route[0].longitude;
            var total = 0;

            // If 0 or smaller just show start
            if (distance <= 0)
            {
               return {latitude: prevLat, longitude: prevLon};
            }

            for (var i = 0; i < route.length; i++) {
                var lat = route[i].latitude;
                var lon = route[i].longitude;

                total += haversineDistance({Latitude: prevLat, Longitude: prevLon}, {Latitude: lat, Longitude: lon})

                if (total >= distance)
                {
                  return {latitude: lat, longitude: lon};
                }

                prevLat = lat;
                prevLon = lon;
            }
            // Distance is further than the end, just show the end
            return {latitude: prevLat, longitude: prevLon};;
         }

         function haversineDistance(latlong1,latlong2){
            //var earthRadius = 6367; // km
            var earthRadius = 3956.27038; // miles
            var lat1 = DegtoRad(latlong1.Latitude);
            var lon1 = DegtoRad(latlong1.Longitude);
            var lat2 = DegtoRad(latlong2.Latitude);
            var lon2 = DegtoRad(latlong2.Longitude);
            var dLat = lat2-lat1;
            var dLon = lon2-lon1;
            var cordLength = Math.pow(Math.sin(dLat/2),2)+Math.cos(lat1)*Math.cos(lat2)*Math.pow(Math.sin(dLon/2),2);
            var centralAngle = 2 * Math.atan2(Math.sqrt(cordLength), Math.sqrt(1-cordLength));
            return earthRadius * centralAngle;
         }

         function DegtoRad(x)
         {
            return x*Math.PI/180;
         }

         function log(message)
         {
            if (console) console.log(message);
         }

      </script>
   </head>
   <body onload="GetMap();"> 
      <div class="navbar navbar-inverse navbar-fixed-top">
         <div class="navbar-inner">
            <div class="container">
               <a class="brand" href="#">Proclaimathon</a>
            </div>
         </div>
      </div>
      <div id='mapDiv' style="position:absolute; width:800px; height:600px;"></div>
<!--       <p style="position:absolute; top: 630px;">
         <input type="textbox" id="distance" value="100"/>
         <input type="button" value="Show" onclick="decodeRoute()"/>
      </p> -->
   </body>
</html>